name: Build and Sign Creapass

# Ce script se lance quand vous poussez du code sur la branche principale
on:
  push:
    branches:
      - main
  # Permet de lancer la compilation manuellement depuis GitHub (bouton "Run workflow")
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    # D√©finition des noms de fichiers
    env:
      EXE_NAME: creapass.exe
      # Nuitka cr√©e ce dossier par d√©faut avec --standalone
      DIST_DIR: creapass.dist
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          # Si vous utilisez une autre version (ex: 3.10), changez le 3.11 ici
          python-version: '3.11' 

      - name: Install Nuitka and Dependencies
        # Installe tout ce qu'il y a dans requirements.txt, plus Nuitka
        run: pip install -r requirements.txt Nuitka

      - name: Compile with Nuitka
        # üö® ATTENTION : C'EST ICI QUE VOUS AUREZ √Ä MODIFIER LA LIGNE
        # Remplacez <VOTRE_COMMANDE_NUITKA> par votre commande exacte

        run: |
          python -m nuitka --quiet --standalone ^
          --windows-icon-from-ico=images_creapass/creapass.ico ^
          --plugin-enable=tk-inter ^
          --include-package-data=ttkbootstrap ^
          --include-module=pyperclip ^
          --include-module=pystray ^
          --include-module=tkhtmlview ^
          --include-module=utilisation ^
          --windows-console-mode=disable ^
          creapass.py
          

      # --- üîë √âTAPES DE SIGNATURE (SignPath) ---
      # Ces √©tapes ne fonctionneront qu'apr√®s l'√âtape 2 ci-dessous.
      
      - name: Submit to SignPath for signing
        uses: signpath/github-action-submit-signing-request@v1
        with:
          # Ces valeurs "secrets" sont les cl√©s de s√©curit√© fournies par SignPath
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          organization-id: ${{ secrets.SIGNPATH_ORGANIZATION_ID }}
          signing-policy-slug: "release-signing"

          # On soumet le dossier entier g√©n√©r√© par Nuitka √† SignPath
          artifact-configuration-slug: "initial"
          github-artifact-name: "${{ env.DIST_DIR }}"
          artifact-path: ${{ env.DIST_DIR }}
          wait-for-completion: true

      - name: Download signed artifacts from SignPath
        uses: signpath/github-action-download-signed-artifacts@v1
        with:
          github-artifact-name: "${{ env.DIST_DIR }}"
          download-path: signed-release

      - name: Upload the final signed release
        uses: actions/upload-artifact@v4
        with:
          name: creapass-signed
          path: signed-release/${{ env.DIST_DIR }}
